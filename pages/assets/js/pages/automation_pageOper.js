var automation_test = {
	_id: "1" ,
	automation_name: "automation_test1" ,
	automation_description: "basic automation test" ,
	automation_no_people_active: 35 ,
	automation_engagement: 82 ,
	automation_connection: 45 ,
	automation_clicks: 35 ,
	automation_state: "trigger1" ,
	automation_fired_time: "" ,
	automation_triggers: [
		{
			_id: "1" ,
			trigger_style: 0 ,
			trigger_fire_time: "start" ,
			trigger_fired_time: "" ,
			trigger_queue_number: 1 ,
			trigger_state: 0 ,
			trigger_action: [
				{
					_id: "1" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 3 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "2" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 2 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "3" ,
					action_style: 2 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 1 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				}
			]
		} ,
		{
			_id: "2" ,
			trigger_style: 1 ,
			trigger_fire_time: "start" ,
			trigger_fired_time: "" ,
			trigger_queue_number: 2 ,
			trigger_state: 0 ,
			trigger_action: [
				{
					_id: "1" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 1 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "2" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 2 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "3" ,
					action_style: 2 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 3 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				}
			]
		} ,
		{
			_id: "3" ,
			trigger_style: 2 ,
			trigger_fire_time: "start" ,
			trigger_fired_time: "" ,
			trigger_queue_number: 3 ,
			trigger_state: 0 ,
			trigger_action: [
				{
					_id: "1" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 1 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "2" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 2 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "3" ,
					action_style: 2 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 3 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				}
			]
		}
	]
};
var automation_test1 = {
	_id: "2" ,
	automation_name: "automation_test" ,
	automation_description: "basic automation test" ,
	automation_no_people_active: 56 ,
	automation_engagement: 12 ,
	automation_connection: 25 ,
	automation_clicks: 86 ,
	automation_state: "trigger1" ,
	automation_fired_time: "" ,
	automation_triggers: [
		{
			_id: "1" ,
			trigger_style: 1 ,
			trigger_fire_time: "start" ,
			trigger_fired_time: "" ,
			trigger_queue_number: 1 ,
			trigger_state: 0 ,
			trigger_action: [
				{
					_id: "1" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 1 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "2" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 2 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "3" ,
					action_style: 2 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 3 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				}
			]
		} ,
		{
			_id: "2" ,
			trigger_style: 2 ,
			trigger_fire_time: "start" ,
			trigger_fired_time: "" ,
			trigger_queue_number: 2 ,
			trigger_state: 0 ,
			trigger_action: [
				{
					_id: "1" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 1 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "2" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 2 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "3" ,
					action_style: 2 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 3 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				}
			]
		} ,
		{
			_id: "3" ,
			trigger_style: 3 ,
			trigger_fire_time: "start" ,
			trigger_fired_time: "" ,
			trigger_queue_number: 3 ,
			trigger_state: 0 ,
			trigger_action: [
				{
					_id: "1" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 1 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "2" ,
					action_style: 1 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 2 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				} ,
				{
					_id: "3" ,
					action_style: 2 ,
					action_fire_time: "start" ,
					action_fired_time: "" ,
					action_queue_number: 3 ,
					action_state: 0 ,
					action_delay_time: "1 Day(s)" ,
					action_parameter: ""
				}
			]
		}
	]
};
// var docs = [automation_test, automation_test1];
var docs = [];

// Trigger Information of Trigger Table variable
var triggerJsonToDraw = {};
//automationListVal:global value
var deleteAutomationModal = document.getElementById('deleteAutomationName');
var deleteAutomationBtn = document.getElementById('deleteAutomation');
var firstAutomationTable = document.getElementById('firstAutomationTable');
var showTriggersDiv = document.getElementById('showTriggersDiv');
var automationSaveBtn = document.getElementById('automationSaveBtn');
var campaigntext = document.getElementById('campaigntext');

var addActionSelect = document.getElementById('addActionSelect');
var addActionBtn = document.getElementById('addActionBtn');
var tagContent = document.getElementById('tagContent');
var openBlankEditBtn = document.getElementById('openBlankEditBtn');

var automationId = document.getElementById('automationId');

//----------------trigger edit modal window DOMs---------------------//

//fixed edit modal window
var conditionSelectDiv = document.getElementById('conditionSelectDiv');
var conditionSelect = document.getElementById('conditionSelect');

var delayTimeNum = document.getElementById('delayTimeNum');
var delayTimeSelect = document.getElementById('delayTimeSelect');

var triggerSaveBtn = document.getElementById('triggerSaveBtn');

var deleteActionBtn = document.getElementById('deleteActionBtn');
var deleteActionModalTriggerId = document.getElementById(
	'deleteActionModalTriggerId');
var deleteActionModalActionId = document.getElementById(
	'deleteActionModalActionId');

var updateActionModalTriggerId = document.getElementById(
	'updateActionModalTriggerId');
var updateActionModalActionId = document.getElementById(
	'updateActionModalActionId');

//changable doms in modal window
var acceptConnectionRequestSelect = document.getElementById(
	'acceptConnectionRequestSelect');
var transferCampaignSelect = document.getElementById('transferCampaignSelect');
var addTagSelect = document.getElementById('addTagSelect');
var sendRecomRequestSelect = document.getElementById('sendRecomRequestSelect');
var sendConnectionRequestSelect = document.getElementById(
	'sendConnectionRequestSelect');
var sendMessageSelect = document.getElementById('sendMessageSelect');
// var sendMessageSelect = document.getElementById('sendMessageSelect');
var visitProfileCheck = document.getElementById('visitProfileCheck');
var withdrawConnectionRequestCheck = document.getElementById(
	'withdrawConnectionRequestCheck');

var add_exText_create = document.getElementById('add_exText_create');

var editBit = false;
var actionEditBit = false;
var messageTemplates;
var TRIGGER_ACTION_LENGTH = false;
//-------------------------------------------------------------------//

//initial edit automation trigger modal window DOMs
var initAddActionModalDom = function() {
	acceptConnectionRequestSelect.selectedIndex = '0';
	transferCampaignSelect.selectedIndex = '0';
	for (var i = 0 , l = addTagSelect.options.length , o; i < l; i++) {
		o = addTagSelect.options[ i ];
		o.selected = false;
	}
	sendRecomRequestSelect.selectedIndex = '0';
	sendConnectionRequestSelect.selectedIndex = '0';
	visitProfileCheck.checked = false;
	withdrawConnectionRequestCheck.checked = false;
};

//initial select box add action modal window function
var initAddActionModalWindow = function() {
	tagContent.innerHTML = '';
	addActionSelect.selectedIndex = '0';
	conditionSelectDiv.style.display = 'none';
	conditionSelect.selectedIndex = '0';
	initAddActionModalDom();
};

// document.getElementById('add_exText_create').
// 	addEventListener('click' , function() {
// 		console.log('clickkkkkkkkkkk');
// 		if ( addField_create.value != 'none' ) {
// 			var tmp = '{{Contact.' + addField_create.value + '}}';
// 			var cursorPos = $('#textarea_message_create').prop('selectionStart');
// 			var v = $('#textarea_message_create').val();
// 			var textBefore = v.substring(0 , cursorPos);
// 			var textAfter = v.substring(cursorPos , v.length);
// 			$('#textarea_message_create').val(textBefore + tmp + textAfter);
// 		}
// 	});
//show automation page
document.getElementById('backAutomation').
	addEventListener('click' , function() {
		// location.reload();
		getAllTableAutomation().then(function( response ) {
			initAddActionModalWindow();
			drawAutomationTable(response);
		}).catch(function( err1 ) {
			console.log(err1);
		});
		document.getElementsByClassName(
			'editCampaigns')[ 0 ].style.display = 'none';
		document.getElementById('main-Content').style.display = 'block';
		campaigntext.value = '';
		automationId.value = '';
	});

//message select changed
var showMessageStyle = function( selectDom ) {
	if ( selectDom.value == 'customMessages' ) {
		document.getElementById(selectDom.id + 'Custom').style.display = 'block';
		document.getElementById(selectDom.id + 'Template').style.display = 'none';
	}
	if ( selectDom.value == 'selectFromTemplate' ) {
		document.getElementById(selectDom.id + 'Custom').style.display = 'none';
		document.getElementById(selectDom.id + 'Template').style.display = 'block';
		console.log(selectDom.id);
		$("#sendMessageSelectList").trigger("customTemplate");
	}
};

$('#sendMessageSelectList').live({
	'customTemplate': function( e ) {
		$('#sendMessageSelectST').val($(this).find(':selected').attr('data-value'));
	} ,
	click: function( e ) {
		console.log('change');
		$('#sendMessageSelectST').val($(this).find(':selected').attr('data-value'));
	} ,
	change: function( e ) {
		$('#sendMessageSelectST').val($(this).find(':selected').attr('data-value'));
	}
});

$('#sendConnectionRequestSelectList').live({
	'customTemplate': function( e ) {
		$('#sendConnectionRequestSelectST').
			val($(this).find(':selected').attr('data-value'));
	} ,
	click: function( e ) {
		console.log(this);
		console.log('change');
		$('#sendConnectionRequestSelectST').
			val($(this).find(':selected').attr('data-value'));
	} ,
	change: function( e ) {
		$('#sendConnectionRequestSelectST').
			val($(this).find(':selected').attr('data-value'));
	}
});

//get Action Parameters from modal window
var getActionParameter = function( actionStyle ) {
	var returnVal;
	switch (parseInt(actionStyle)) {
		case 0:
			returnVal = document.getElementById('visitProfileCheck').checked;
			break;
		case 1:
			var selTmp = document.getElementById('sendMessageSelect');
			returnVal = {};
			returnVal.event = selTmp.options[ selTmp.selectedIndex ].value;
			if ( returnVal.event == 'customMessages' ) {
				returnVal.content = document.getElementById(selTmp.id + 'CM').value;
				console.log(returnVal);
			}
			if ( returnVal.event == 'selectFromTemplate' ) {

				// console.log(document.getElementById(selTmp.id + 'List').value);
				// returnVal.content = document.getElementById(selTmp.id + 'List').value;
				returnVal.content = $('#sendMessageSelectST').val();
				returnVal.message_template = $('#sendMessageSelectST').val();
			}
			break;
		case 2:
			var selTmp = document.getElementById('sendConnectionRequestSelect');
			returnVal = {};
			returnVal.event = selTmp.options[ selTmp.selectedIndex ].value;
			if ( returnVal.event == 'customMessages' ) {
				returnVal.content = document.getElementById(selTmp.id + 'CM').value;
				console.log(returnVal);
			}
			if ( returnVal.event == 'selectFromTemplate' ) {
				returnVal.content = document.getElementById(selTmp.id + 'List').value;
			}
			break;
		case 3:
			var selTmp = document.getElementById('sendRecomRequestSelect');
			returnVal = {};
			returnVal.event = selTmp.options[ selTmp.selectedIndex ].value;
			if ( returnVal.event == 'customMessages' ) {
				returnVal.content = document.getElementById(selTmp.id + 'CM').value;
				console.log(returnVal);
			}
			if ( returnVal.event == 'selectFromTemplate' ) {
				returnVal.content = document.getElementById(selTmp.id + 'List').value;
			}
			break;
		case 4:
			returnVal = getArrayFromSelect(document.getElementById('addTagSelect'));
			break;
		case 5:
			returnVal = document.getElementById(
				'transferCampaignSelect').options[ document.getElementById(
				'transferCampaignSelect').selectedIndex ].value;
			break;
		case 6:
			returnVal = document.getElementById(
				'acceptConnectionRequestSelect').options[ document.getElementById(
				'acceptConnectionRequestSelect').selectedIndex ].value;
			break;
		case 7:
			returnVal = document.getElementById(
				'withdrawConnectionRequestCheck').checked;
			break;
			break;
	}
	return returnVal;
};

//set Action Parameters from modal window
var setActionParameter = function( actionData ) {
	console.log('click set action parameter')
	console.log(actionData)
	switch (parseInt(actionData.action_style)) {
		case 0:
			document.getElementById(
				'visitProfileCheck').checked = actionData.action_parameter;
			break;
		case 1:
			var selTmp = document.getElementById('sendMessageSelect');
			showMessageStyle(selTmp);
			if ( actionData.action_parameter.event == 'customMessages' ) {
				selTmp.options[ 1 ].selected = true;
				document.getElementById(selTmp.id +
					'CM').value = actionData.action_parameter.content;
				document.getElementById(selTmp.id + 'Custom').style.display = 'block';
				document.getElementById(selTmp.id + 'Template').style.display = 'none';
			}

			if ( actionData.action_parameter.event == 'selectFromTemplate' ) {
				selTmp.options[ 0 ].selected = true;
				for (var i = 0; i <
				document.getElementById(selTmp.id + 'List').options.length; i++) {
					if ( actionData.action_parameter.content ==
						document.getElementById(selTmp.id + 'List').options[ i ].value ) {
						document.getElementById(selTmp.id +
							'List').options[ i ].selected = true;
					}
				}
				document.getElementById(selTmp.id + 'Custom').style.display = 'none';
				document.getElementById(selTmp.id + 'Template').style.display = 'block';
			}
			break;
		case 2:
			var selTmp = document.getElementById('sendConnectionRequestSelect');
			showMessageStyle(selTmp);
			if ( actionData.action_parameter.event == 'customMessages' ) {
				selTmp.options[ 1 ].selected = true;
				document.getElementById(selTmp.id +
					'CM').value = actionData.action_parameter.content;
				document.getElementById(selTmp.id + 'Custom').style.display = 'block';
				document.getElementById(selTmp.id + 'Template').style.display = 'none';
			}

			if ( actionData.action_parameter.event == 'selectFromTemplate' ) {
				selTmp.options[ 0 ].selected = true;
				for (var i = 0; i <
				document.getElementById(selTmp.id + 'List').options.length; i++) {
					if ( actionData.action_parameter.content ==
						document.getElementById(selTmp.id + 'List').options[ i ].value ) {
						document.getElementById(selTmp.id +
							'List').options[ i ].selected = true;
					}
				}
				document.getElementById(selTmp.id + 'Custom').style.display = 'none';
				document.getElementById(selTmp.id + 'Template').style.display = 'block';
			}
			break;
		case 3:
			console.log('case 3')
			var selTmp = document.getElementById('sendRecomRequestSelect');
			showMessageStyle(selTmp);
			if ( actionData.action_parameter.event == 'customMessages' ) {
				selTmp.options[ 1 ].selected = true;
				document.getElementById(selTmp.id +
					'CM').value = actionData.action_parameter.content;
				document.getElementById(selTmp.id + 'Custom').style.display = 'block';
				document.getElementById(selTmp.id + 'Template').style.display = 'none';
			}

			if ( actionData.action_parameter.event == 'selectFromTemplate' ) {
				selTmp.options[ 0 ].selected = true;
				for (var i = 0; i <
				document.getElementById(selTmp.id + 'List').options.length; i++) {
					if ( actionData.action_parameter.content ==
						document.getElementById(selTmp.id + 'List').options[ i ].value ) {
						document.getElementById(selTmp.id +
							'List').options[ i ].selected = true;
					}
				}
				document.getElementById(selTmp.id + 'Custom').style.display = 'none';
				document.getElementById(selTmp.id + 'Template').style.display = 'block';
			}
			break;
		case 4:
			console.log('case 4')
			var a = document.getElementById('addTagSelect');
			for (var i = 0; i < actionData.action_parameter.length; i++) {
				console.log(actionData.action_parameter[ i ]);
				var opt = document.createElement('option');
				opt.value = actionData.action_parameter[ i ];
				opt.text = actionData.action_parameter[ i ];
				opt.selected = true;
				a.appendChild(opt);
			}

			$('#addTagSelect').select2({
				tags: true ,
				tokenSeparators: [ ',' ]
			});
			break;
		case 6:
			for (var i = 0; i <
			document.getElementById('transferCampaignSelect').options.length; i++) {
				if ( document.getElementById(
						'transferCampaignSelect').options[ i ].value ==
					actionData.action_parameter ) {
					document.getElementById(
						'transferCampaignSelect').options[ i ].selected = true;
				}
			}
			break;
		case 7:
			for (var i = 0; i < document.getElementById(
				'acceptConnectionRequestSelect').options.length; i++) {
				if ( document.getElementById(
						'acceptConnectionRequestSelect').options[ i ].value ==
					actionData.action_parameter ) {
					document.getElementById(
						'acceptConnectionRequestSelect').options[ i ].selected = true;
				}
			}
	}
};

//set Edit Action Modal
var setActionModal = function( triggerId , actionId ) {
	actionEditBit = true;
	updateActionModalTriggerId.value = triggerId;
	updateActionModalActionId.value = actionId;
	var response = triggerJsonToDraw;

	for (var i = 0; i < response.automation_triggers.length; i++) {
		if ( response.automation_triggers[ i ]._id == triggerId ) {
			for (var j = 0; j <
			response.automation_triggers[ i ].trigger_action.length; j++) {
				if ( response.automation_triggers[ i ].trigger_action[ j ]._id ==
					actionId ) {
					//set action edit modal window
					for (var k = 0; k < addActionSelect.options.length; k++) {
						if ( addActionSelect.options[ k ].value ==
							response.automation_triggers[ i ].trigger_action[ j ].action_style ) {
							addActionSelect.selectedIndex = k;
							var selectVal = selectActionTitle(k);
							if ( selectVal != "none" ) {
								tagContent.innerHTML = document.getElementById(
									selectVal).innerHTML;
								if ( selectVal == "addTag" ) {
									$('#addTagSelect').select2({
										tags: true ,
										tokenSeparators: [ ',' ]
									});
								}
								initAddActionModalDom();
								conditionSelectDiv.style.display = 'block';
							} else {
								tagContent.innerHTML = '';
							}
							let action_parameter = response.automation_triggers[ i ].trigger_action[ j ].action_parameter;
							if ( action_parameter ) {
								// console.log('sendMessageSeelect');
								action_parameter.event = "customMessages";
								$('#sendMessageSelect').val(action_parameter.event);
								showMessageStyle($('#sendMessageSelect').get(0));
								// let isFromTemplate = action_parameter.event ==
								// 	"selectFromTemplate";

								console.log(action_parameter.content);
								$("#sendMessageSelectCM").val(action_parameter.content);
								// isFromTemplate ? $('#sendMessageSelectList').
								// 	trigger('customTemplate') : null;
								// isFromTemplate
								// 	? $("#sendMessageSelectList").value = action_parameter.content
								// 	: $("#sendMessageSelectCM").value = action_parameter.content;
							}
						}
					}

					for (var k = 0; k < conditionSelect.options.length; k++) {
						if ( response.automation_triggers[ i ].trigger_style ==
							conditionSelect.options[ k ].value ) {
							conditionSelect.selectedIndex = k;
						}
					}
					for (var k = 0; k < delayTimeSelect.options.length; k++) {
						if ( response.automation_triggers[ i ].trigger_action[ j ].action_delay_time.indexOf(
								delayTimeSelect.options[ k ].value) > 0 ) {
							delayTimeSelect.selectedIndex = k;
						}
						delayTimeNum.value = response.automation_triggers[ i ].trigger_action[ j ].action_delay_time.charAt(
							0);
					}
					////set Action Parameter function part.
					setActionParameter(
						response.automation_triggers[ i ].trigger_action[ j ]);
					$('#modal-edit-action').modal('show');
				}
			}
		}
	}
	conditionSelect.disabled = true;

	document.getElementById('sendMessageSelectList').
		addEventListener('change' , function( e ) {

			document.getElementById('sendMessageST').value = $(
				'#sendMessageSelectList option:selected').data('value');
		});
	document.getElementById('sendMessageSelect').
		addEventListener('change' , function( e ) {
			console.log('channge');
			let isFromTemplate = $('#sendMessageSelect').val() ==
				"selectFromTemplate";
			isFromTemplate ? document.getElementById('sendMessageST').value = $(
				'#sendMessageSelectList option:selected').data('value') : null;
		});
};

// click delete action button
var deleteActionModal = function( triggerId , actionId ) {
	deleteActionModalTriggerId.value = triggerId;
	deleteActionModalActionId.value = actionId;
};

//automation save button click function
automationSaveBtn.addEventListener('click' , function() {
	console.log('click save auto');
	if ( editBit == false ) {
		for (var i = 0; i < automationListVal.length; i++) {
			if ( automationListVal[ i ] == campaigntext.value ) {
				return false;
			}
		}
	}
	if ( (!triggerJsonToDraw.automation_triggers) ||
		(triggerJsonToDraw.automation_triggers == 0) ) {
		alert('Please insert triggers');
		return false;
	}
	if ( campaigntext.value == '' ) {
		alert('Please insert automation name');
		return false;
	}
	//save automation function
	if ( editBit === false ) {
		triggerJsonToDraw.automation_name = campaigntext.value;
		triggerJsonToDraw.automation_description = '';
		triggerJsonToDraw.automation_no_people_active = 0;
		triggerJsonToDraw.automation_engagement = 0;
		triggerJsonToDraw.automation_connection = 0;
		triggerJsonToDraw.automation_clicks = 0;
		triggerJsonToDraw.automation_state = 'Trigger1';
		triggerJsonToDraw.automation_fired_time = '';
		automationListVal.push(triggerJsonToDraw.automation_name);
		triggerJsonToDraw._id = new Date().toJSON();
		saveTableAutomation(triggerJsonToDraw).then(function( response ) {
			alert('Template Saved');
			getAllTableAutomation().then(function( response ) {
				initAddActionModalWindow();
				drawAutomationTable(response);
				TRIGGER_ACTION_LENGTH = false;
			}).catch(function( err1 ) {
				console.log(err1);
			});
		}).catch(function( err ) {
			alert(err.message);
		});
	}
	if ( editBit === true ) {
		table_automation.get(automationId.value + '').then(function( doc ) {
			return table_automation.upsert(doc._id , function( doc_ ) {
				doc_.automation_triggers = triggerJsonToDraw.automation_triggers;
				return doc_;
			}).then(function( res ) {
				getAllTableAutomation().then(function( response ) {
					alert('Template Updated');
					initAddActionModalWindow();
					drawAutomationTable(response);
					TRIGGER_ACTION_LENGTH = false;
				}).catch(function( err1 ) {
					console.log(err1);
				});
			}).catch(function( err ) {
				// error
			});
		}).then(function( response ) {
			// handle response
		}).catch(function( err ) {
			console.log(err);
		});
	}
	document.getElementsByClassName('editCampaigns')[ 0 ].style.display = 'none';
	document.getElementById('main-Content').style.display = 'block';
	campaigntext.value = '';
	automationId.value = '';
});

//trigger save button click function
triggerSaveBtn.addEventListener('click' , function() {
	if ( !delayTimeNum.value ) {
		delayTimeNum.value = 0;
	}
	if ( conditionSelect.options[ conditionSelect.selectedIndex ].value < 0 ) {
		alert('Please select trigger name');
		return false;
	}
	var delayTime = '';
	delayTime = delayTimeNum.value + ' ' +
		delayTimeSelect.options[ delayTimeSelect.selectedIndex ].value;

	var triggerTmp = {};
	var actionTmp = {};
	if ( actionEditBit == true ) {
		actionTmp._id = updateActionModalActionId.value;
	} else {
		actionTmp._id = new Date().toJSON();
	}
	actionTmp.action_style = addActionSelect.options[ addActionSelect.selectedIndex ].value;
	actionTmp.action_fire_time = '';
	actionTmp.action_fired_time = '';
	actionTmp.action_state = 0;
	actionTmp.action_delay_time = delayTime;
	actionTmp.action_parameter = [];

	if ( !triggerJsonToDraw.automation_triggers ) {
		triggerJsonToDraw.automation_triggers = [];
		triggerTmp._id = new Date().toJSON();
		triggerTmp.trigger_style = conditionSelect.options[ conditionSelect.selectedIndex ].value;
		triggerTmp.trigger_fire_time = 'start';
		triggerTmp.trigger_fired_time = '';
		triggerTmp.trigger_queue_number = '1';
		triggerTmp.trigger_state = '0';
		triggerTmp.trigger_action = [];
		if ( actionEditBit == true ) {

		} else {
			actionTmp.action_queue_number = 1;
			actionTmp.action_parameter = getActionParameter(
				addActionSelect.options[ addActionSelect.selectedIndex ].value);
			triggerTmp.trigger_action.push(actionTmp);
		}
		triggerJsonToDraw.automation_triggers.push(triggerTmp);
	} else {
		for (var i = 0; i < triggerJsonToDraw.automation_triggers.length; i++) {
			if ( triggerJsonToDraw.automation_triggers[ i ].trigger_style ==
				conditionSelect.options[ conditionSelect.selectedIndex ].value ) {
				if ( actionEditBit == true ) {
					for (var j = 0; j <
					triggerJsonToDraw.automation_triggers[ i ].trigger_action.length; j++) {
						if ( triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ]._id ==
							updateActionModalActionId.value ) {
							actionTmp.action_queue_number = triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number;
							actionTmp.action_parameter = getActionParameter(
								addActionSelect.options[ addActionSelect.selectedIndex ].value);
							triggerJsonToDraw.automation_triggers[ i ].trigger_action.splice(
								j , 1);
							triggerJsonToDraw.automation_triggers[ i ].trigger_action.push(
								actionTmp);
						}
					}
				} else {
					actionTmp.action_queue_number = triggerJsonToDraw.automation_triggers[ i ].trigger_action.length +
						1;
					actionTmp.action_parameter = getActionParameter(
						addActionSelect.options[ addActionSelect.selectedIndex ].value);
					triggerJsonToDraw.automation_triggers[ i ].trigger_action.push(
						actionTmp);
				}
				showTriggersDiv.innerHTML = drawTriggerTableByJson(triggerJsonToDraw);
				return true;
			}
		}
		triggerTmp._id = new Date().toJSON();
		triggerTmp.trigger_style = conditionSelect.options[ conditionSelect.selectedIndex ].value;
		triggerTmp.trigger_fire_time = 'start';
		triggerTmp.trigger_fired_time = '';
		triggerTmp.trigger_queue_number = '1';
		triggerTmp.trigger_state = '0';
		triggerTmp.trigger_action = [];
		if ( actionEditBit == true ) {

		} else {
			actionTmp.action_queue_number = 1;
			actionTmp.action_parameter = getActionParameter(
				addActionSelect.options[ addActionSelect.selectedIndex ].value);
			triggerTmp.trigger_action.push(actionTmp);
		}
		triggerJsonToDraw.automation_triggers.push(triggerTmp);
	}
	showTriggersDiv.innerHTML = drawTriggerTableByJson(triggerJsonToDraw);
	updateActionModalTriggerId.value = '';
	updateActionModalActionId.value = '';
	$('#modal-edit-action').modal('hide');

});

//select change function in edit modal window
addActionSelect.addEventListener('change' , function() {
	console.log(selectActionTitle(this.value));
	var selectVal = selectActionTitle(this.value);
	if ( selectVal != "none" ) {
		tagContent.innerHTML = document.getElementById(selectVal).innerHTML;
		if ( (selectVal == 'sendRecomRequest') ||
			(selectVal == 'sendConnectionRequest') || (selectVal == 'sendMessage') ) {
			// $("#sendMessageSelectList").trigger("customTemplate");
			// $("#sendConnectionRequestSelectList").trigger("customTemplate");
			document.getElementById(selectVal + 'Select').selectedIndex = 0;
			document.getElementById(selectVal +
				'SelectTemplate').style.display = 'block';
			document.getElementById(selectVal +
				'SelectCustom').style.display = 'none';
		}
		if ( selectVal == "addTag" ) {
			$('#addTagSelect').select2({
				tags: true ,
				tokenSeparators: [ ',' ]
			});
		}
		initAddActionModalDom();
		conditionSelectDiv.style.display = 'block';
		delayTimeNum.value = '';
		delayTimeSelect.selectedIndex = 0;
	} else {
		tagContent.innerHTML = '';
	}
});

//add trigger and action button
addActionBtn.addEventListener('click' , function() {
	actionEditBit = false;
	conditionSelect.disabled = false;
	initAddActionModalWindow();
	tagContent.innerHTML = document.getElementById('visitProfile').innerHTML;
	conditionSelectDiv.style.display = 'block';
});

// add new automation button click function
openBlankEditBtn.addEventListener('click' , function() {
	triggerJsonToDraw = {};
	showTriggersDiv.innerHTML = '';
	editBit = false;
	campaigntext.value = '';
	campaigntext.disabled = false;
	automationId.value = '';
	document.getElementsByClassName('editCampaigns')[ 0 ].style.display = 'block';
	document.getElementById('main-Content').style.display = 'none';
});

//click delete action button
deleteActionBtn.addEventListener('click' , function() {
	var triggerId = deleteActionModalTriggerId.value;
	var actionId = deleteActionModalActionId.value;
	var triggerNum = -1;
	var actionNum = -1;
	var queueNum = -1;
	var response = triggerJsonToDraw;
	for (var i = 0; i < response.automation_triggers.length; i++) {
		if ( response.automation_triggers[ i ]._id == triggerId ) {
			for (var j = 0; j <
			response.automation_triggers[ i ].trigger_action.length; j++) {
				if ( response.automation_triggers[ i ].trigger_action[ j ]._id ==
					actionId ) {
					triggerNum = i;
					actionNum = j;
					queueNum = response.automation_triggers[ i ].trigger_action[ j ].action_queue_number;
				}
			}
		}
	}

	// delete action edit modal window
	if ( response.automation_triggers[ triggerNum ].trigger_action.length == 1 ) {
		console.log('deleteTrigger');
		response.automation_triggers.splice(triggerNum , 1);
	} else {
		console.log('deleteAction');
		for (var j = 0; j <
		response.automation_triggers[ triggerNum ].trigger_action.length; j++) {
			if ( parseInt(
					response.automation_triggers[ triggerNum ].trigger_action[ j ].action_queue_number) >
				parseInt(queueNum) ) {
				response.automation_triggers[ triggerNum ].trigger_action[ j ].action_queue_number = parseInt(
					response.automation_triggers[ triggerNum ].trigger_action[ j ].action_queue_number) -
					1;
			}
		}
		response.automation_triggers[ triggerNum ].trigger_action.splice(actionNum ,
			1);
	}

	triggerJsonToDraw = response;
	showTriggersDiv.innerHTML = drawTriggerTableByJson(triggerJsonToDraw);

});

var changeQueueDown = function( triggerId , actionId , action_queue_number ) {
	for (var i = 0; i < triggerJsonToDraw.automation_triggers.length; i++) {
		if ( triggerJsonToDraw.automation_triggers[ i ]._id == triggerId ) {
			for (var j = 0; j <
			triggerJsonToDraw.automation_triggers[ i ].trigger_action.length; j++) {
				if ( triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number ==
					(action_queue_number + '') ) {
					//set action edit modal window
					triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number = parseInt(
						action_queue_number) + 1;
				} else if ( triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number ==
					(parseInt(action_queue_number) + 1 + '') ) {
					triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number = parseInt(
						action_queue_number);
				}
			}
		}
	}
	showTriggersDiv.innerHTML = drawTriggerTableByJson(triggerJsonToDraw);
};

var changeQueueUp = function( triggerId , actionId , action_queue_number ) {
	for (var i = 0; i < triggerJsonToDraw.automation_triggers.length; i++) {
		if ( triggerJsonToDraw.automation_triggers[ i ]._id == triggerId ) {
			for (var j = 0; j <
			triggerJsonToDraw.automation_triggers[ i ].trigger_action.length; j++) {
				if ( triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number ==
					(action_queue_number + '') ) {
					//set action edit modal window
					triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number = parseInt(
						action_queue_number) - 1;
				} else if ( triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number ==
					(parseInt(action_queue_number) - 1 + '') ) {
					triggerJsonToDraw.automation_triggers[ i ].trigger_action[ j ].action_queue_number = parseInt(
						action_queue_number);
				}
			}
		}
	}
	showTriggersDiv.innerHTML = drawTriggerTableByJson(triggerJsonToDraw);
};

////////////-------------------style convert by number functions--------------------//////////////////

////////////-------------------style convert by number functions--------------------//////////////////
//----------------------------------------------------------------------------------//

////////////-------------------draw functions--------------------//////////////////

//draw automation first page table
var drawAutomationTable = function( automationData ) {
	var automationDataRows = automationData.rows;
	var firstAutomationTableContent = '<table class="table largeTable">' +
		'<thead>' +
		'<tr>' +
		'<th>Name</th>' +
		'<th>Description</th>' +
		'<th>No people active</th>' +
		'<th>Engagement Rate</th>' +
		'<th>Connection</th>' +
		'<th>Clicks</th>' +
		'<th>Actions</th>' +
		'</tr>' +
		'</thead><tbody>';
	for (var i = 0; i < automationData.total_rows; i++) {
		firstAutomationTableContent += '<tr>' +
			'<td>' + automationDataRows[ i ].doc.automation_name + '</td>' +
			'<td>' + automationDataRows[ i ].doc.automation_description + '</td>' +
			'<td>' + automationDataRows[ i ].doc.automation_no_people_active +
			'</td>' +
			'<td>' + automationDataRows[ i ].doc.automation_engagement + '%' +
			'</td>' +
			'<td>' + automationDataRows[ i ].doc.automation_connection + '</td>' +
			'<td>' + automationDataRows[ i ].doc.automation_clicks + '</td>' +
			'<td>' +
			'<button type="button" class="btn btn-info" onclick="openEditPage(\'' +
			automationDataRows[ i ].doc._id +
			'\')"><i class="fa fa-edit"></i></button>' +
			'<button type="button" class="btn btn-danger" data-toggle="modal" data-dismiss="modal" data-target="#modal-delete-automation" onclick="deleteAutomationInfo(\'' +
			automationDataRows[ i ].doc._id +
			'\')"><i class="fa fa-trash-o"></i></button>' +
			'</td>' +
			'</tr>';
	}
	firstAutomationTableContent += '</tbody></table>';
	firstAutomationTable.innerHTML = firstAutomationTableContent;
};

//draw trigger window
var drawTriggerTableByJson = function( docInfo ) {
	console.log('+++++++');
	TRIGGER_ACTION_LENGTH = false;
	var triggerTmp = '';
	for (var i = 0; i < docInfo.automation_triggers.length; i++) {
		triggerTmp += '<table class="table largeTable">' +
			'<thead>' +
			'<tr>' +
			'<th>' +
			selectTriggerStyle(docInfo.automation_triggers[ i ].trigger_style) +
			'</th>' +
			'<th style="width:30%">Term</th>' +
			'<th style="width:10%">Action</th>' +
			'<th style="width:10%">Queue</th>' +
			'</tr>' +
			'</thead>' +
			'<tbody>';
		var trigger_action = docInfo.automation_triggers[ i ].trigger_action;
		for (var k = 0; k < trigger_action.length; k++) { //loop for queue number
			for (var j = 0; j < trigger_action.length; j++) {
				TRIGGER_ACTION_LENGTH = true;  //check if action list is greater than 0
				if ( k == (parseInt(trigger_action[ j ].action_queue_number) - 1) ) {
					console.log(trigger_action[ j ].action_delay_time);
					triggerTmp += '<tr>' + '<input type="hidden" value ="' +
						trigger_action[ j ]._id + '">' +
						'<td>' + selectActionStyle(trigger_action[ j ].action_style) +
						'</td>' +
						'<td>' + trigger_action[ j ].action_delay_time + '</td>' +
						'<td>' +
						'<button type="button" class="btn btn-info" data-toggle="modal" data-dismiss="modal"  onclick="setActionModal(\'' +
						docInfo.automation_triggers[ i ]._id + '\',\'' +
						trigger_action[ j ]._id +
						'\')"><i class="fa fa-edit"></i></button>' +
						'<button type="button" class="btn btn-danger" data-toggle="modal" data-dismiss="modal" data-target="#modal-delete-action" onclick="deleteActionModal(\'' +
						docInfo.automation_triggers[ i ]._id + '\',\'' +
						trigger_action[ j ]._id +
						'\')"><i class="fa fa-trash-o"></i></button>' +
						'</td><td>';
					if ( k == 0 ) {
						triggerTmp += '<button type="button" class="btn btn-default" disabled><i class="fa fa-arrow-up"></i></button>';
						if ( k == (trigger_action.length - 1) ) {
							triggerTmp += '<button type="button" class="btn btn-default" disabled><i class="fa fa-arrow-down"></i></button>';
						} else {
							triggerTmp += '<button type="button" class="btn btn-default" onclick="changeQueueDown(\'' +
								docInfo.automation_triggers[ i ]._id + '\',\'' +
								trigger_action[ j ]._id + '\',\'' +
								trigger_action[ j ].action_queue_number +
								'\')"><i class="fa fa-arrow-down"></i></button>';
						}
					} else {
						triggerTmp += '<button type="button" class="btn btn-default" onclick="changeQueueUp(\'' +
							docInfo.automation_triggers[ i ]._id + '\',\'' +
							trigger_action[ j ]._id + '\',\'' +
							trigger_action[ j ].action_queue_number +
							'\')"><i class="fa fa-arrow-up"></i></button>';
						if ( k == (trigger_action.length - 1) ) {
							triggerTmp += '<button type="button" class="btn btn-default" disabled><i class="fa fa-arrow-down"></i></button>';
						} else {
							triggerTmp += '<button type="button" class="btn btn-default" onclick="changeQueueDown(\'' +
								docInfo.automation_triggers[ i ]._id + '\',\'' +
								trigger_action[ j ]._id + '\',\'' +
								trigger_action[ j ].action_queue_number +
								'\')"><i class="fa fa-arrow-down"></i></button>';
						}
					}
					triggerTmp += '</tr>';
				}
			}
		}
		triggerTmp += '</tbody>' +
			'</table>';
	}
	return triggerTmp;
};

////////////-------------------draw functions--------------------//////////////////
//-------------------------------------------------------------------------------//

//open edit automation window
var openEditPage = function( docId ) {
	getDataTableAutomation(docId.toString()).then(function( response ) {
		//convert html
		triggerJsonToDraw = response;
		showTriggersDiv.innerHTML = drawTriggerTableByJson(triggerJsonToDraw);
		editBit = true;
		campaigntext.value = triggerJsonToDraw.automation_name;
		campaigntext.disabled = true;
		automationId.value = triggerJsonToDraw._id;
		//draw trigger table
		document.getElementsByClassName(
			'editCampaigns')[ 0 ].style.display = 'block';
		document.getElementById('main-Content').style.display = 'none';
	}).catch(function( err ) {
		console.log(err.message);
	});
};

////////////////////////////---------------delete automation part--------------------///////////////
//delete automation information--register automation infor to modal window.
var deleteAutomationInfo = function( docId ) {
	deleteAutomationModal.value = docId;
};

//delete automation
var deleteAutomation = function() {
	var docId = deleteAutomationModal.value;
	getDataTableAutomation(docId + '').then(function( response ) {
		return table_automation.remove(response);
	}).then(function( response ) {
		// $('#modal-delete').modal('hide');
		getAllTableAutomation().then(function( response ) {
			drawAutomationTable(response);
		}).catch(function( err1 ) {
			console.log(err1);
		});
	}).catch(function( err ) {
		console.log(err.message);
	});
};

//delete automation button click event
deleteAutomationBtn.addEventListener('click' , function() {
	$('#modal-delete-automation').modal('hide');
	deleteAutomation();
});
////////////////////////////---------------delete automation part--------------------///////////////
//------------------------------------------------------------------------------------------------//

// bulkDataTableAutomaion(docs).then(function(response) {
//     getAllTableAutomation().then(function(res) {
//         drawAutomationTable(res);
//     }).catch(function(err1) {
//         console.log(err1.message);
//     });
// }).catch(function(err) {
//     console.log(err.message);
// });

getAllTableAutomation().then(function( response ) {
	initAddActionModalWindow();
	drawAutomationTable(response);
	for (var i = 0; i < response.rows.length; i++) {
		automationListVal.push(response.rows[ i ].doc.automation_name);
	}
}).catch(function( err1 ) {
	console.log(err1);
});

getAllTableMessageTemplate().then(function( response ) {
	messageTemplates = response;
	for (var i = 0; i < response.rows.length; i++) {
		var opt = document.createElement('option');
		opt.value = response.rows[ i ].doc._id;
		opt.text = response.rows[ i ].doc._id;
		$(opt).attr('data-value' , response.rows[ i ].doc.message_text);
		document.getElementById('sendMessageSelectList').appendChild(opt);
	}

	for (var i = 0; i < response.rows.length; i++) {
		var opt = document.createElement('option');
		opt.value = response.rows[ i ].doc._id;
		opt.text = response.rows[ i ].doc._id;
		$(opt).attr('data-value' , response.rows[ i ].doc.message_text);
		document.getElementById('sendRecomRequestSelectList').appendChild(opt);
	}

	for (var i = 0; i < response.rows.length; i++) {
		var opt = document.createElement('option');
		opt.value = response.rows[ i ].doc._id;
		opt.text = response.rows[ i ].doc._id;
		$(opt).attr('data-value' , response.rows[ i ].doc.message_text);
		document.getElementById('sendConnectionRequestSelectList').appendChild(opt);
	}

	//document.getElementById('sendMessageST').value = 'response.rows[0].doc.message_text';

}).catch(function( err ) {
	alert(err.message);
});

document.getElementById('sendMessageSelectList').
	addEventListener('change' , function() {
		console.log('change');
	});